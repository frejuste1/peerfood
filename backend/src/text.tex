document.addEventListener('DOMContentLoaded', function () {
    // Centralisation des URLs d'API
    const API_ENDPOINTS = {
        BASE: 'http://localhost:8086/customer',
        UPDATE: (id) => `http://localhost:8086/customer/update/${id}`,
        DELETE: (id) => `http://localhost:8086/customer/delete/${id}`,
        STATUS: (id, param) => `http://localhost:8086/account/${id}/${param}`
    };

    // Éléments du DOM
    const tbody = document.querySelector('.table tbody');
    const selectAllCheckbox = document.getElementById('selectAll');
    const searchInput = document.querySelector('#search-input');
    const modal = document.getElementById('newClientModal');
    const addClientBtn = document.querySelector('[data-action="add-client"]');
    const closeButtons = document.querySelectorAll('[data-dismiss="modal"]');
    const saveClientBtn = document.getElementById('saveClient');
    const clientForm = document.getElementById('newClientForm');
    let currentPage = 1;
    const clientsPerPage = 10;
    let totalClients = 0;

    // Éléments du formulaire à deux étapes
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const progressBar = document.querySelector('.progress-bar');
    const steps = document.querySelectorAll('.step');
    const nextBtn = document.getElementById('nextStep');
    const prevBtn = document.getElementById('prevStep');

    // Champs du formulaire
    const clientFirstName = document.getElementById("clientFirstName");
    const clientLastName = document.getElementById("clientLastName");
    const clientPhone = document.getElementById("clientPhone");
    const clientEmail = document.getElementById("clientEmail");
    const customerId = document.getElementById("customerId");
    const clientUsername = document.getElementById("clientUsername");
    const clientPassword = document.getElementById("clientPassword");
    const clientRole = document.getElementById("clientRole");

    // Messages d'aide
    const clientFirstNameHelp = document.getElementById("clientFirstNameHelp");
    const clientLastNameHelp = document.getElementById("clientLastNameHelp");
    const clientPhoneHelp = document.getElementById("clientPhoneHelp");
    const clientEmailHelp = document.getElementById("clientEmailHelp");
    const customerIdHelp = document.getElementById("customerIdHelp");
    const clientUsernameHelp = document.getElementById("clientUsernameHelp");
    const clientPasswordHelp = document.getElementById("clientPasswordHelp");

    let currentStep = 1;
    const totalSteps = 2;

    // Initialisation du formulaire à étapes
    function initFormSteps() {
        nextBtn.addEventListener('click', function() {
            if (validateCurrentStep()) {
                goToStep(currentStep + 1);
            }
        });

        prevBtn.addEventListener('click', function() {
            goToStep(currentStep - 1);
        });

        saveClientBtn.addEventListener('click', function(event) {
            if (validateCurrentStep()) {
                const isEditing = saveClientBtn.hasAttribute('data-edit-id');
                if (isEditing) {
                    updateClient(event);
                } else {
                    addClient(event);
                }
            }
        });

        addClientBtn.addEventListener('click', function() {
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');

            if (!document.querySelector('.modal-backdrop')) {
                const backdrop = document.createElement('div');
                backdrop.classList.add('modal-backdrop', 'fade', 'show');
                document.body.appendChild(backdrop);
            }

            resetForm();
        });

        closeButtons.forEach(button => {
            button.addEventListener('click', closeModal);
        });

        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal();
            }
        });
    }

    function goToStep(stepNumber) {
        if (stepNumber < 1 || stepNumber > totalSteps) return;

        if (currentStep === 1) {
            step1.style.display = 'none';
        } else if (currentStep === 2) {
            step2.style.display = 'none';
        }

        if (stepNumber === 1) {
            step1.style.display = 'block';
            nextBtn.style.display = 'block';
            prevBtn.style.display = 'none';
            saveClientBtn.style.display = 'none';
            progressBar.style.width = '50%';
            progressBar.setAttribute('aria-valuenow', '50');
        } else if (stepNumber === 2) {
            step2.style.display = 'block';
            nextBtn.style.display = 'none';
            prevBtn.style.display = 'block';
            saveClientBtn.style.display = 'block';
            progressBar.style.width = '100%';
            progressBar.setAttribute('aria-valuenow', '100');
        }

        steps.forEach(function(step) {
            const stepIndex = parseInt(step.getAttribute('data-step'));
            step.classList.remove('active', 'completed');
            if (stepIndex === stepNumber) {
                step.classList.add('active');
            } else if (stepIndex < stepNumber) {
                step.classList.add('completed');
            }
        });

        currentStep = stepNumber;
    }

    function closeModal() {
        modal.classList.remove('show');
        modal.style.display = 'none';
        document.body.classList.remove('modal-open');
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) backdrop.remove();
        saveClientBtn.removeAttribute('data-edit-id');
        resetForm();
    }

    function resetForm() {
        clientForm.reset();
        goToStep(1);
        const formInputs = document.querySelectorAll('#newClientForm input, #newClientForm select');
        formInputs.forEach(input => {
            input.classList.remove('is-valid', 'is-invalid');
        });
        const helpTexts = document.querySelectorAll('#newClientForm .form-text');
        helpTexts.forEach(help => {
            help.textContent = help.getAttribute('data-default-text') || help.textContent;
        });
    }

    // Validations des champs
    clientFirstName.addEventListener("input", () => {
        const value = clientFirstName.value.trim();
        if (!/^[a-zA-ZÀ-ÿ]+$/.test(value)) {
            clientFirstNameHelp.textContent = "⚠️ Le prénom doit contenir uniquement des lettres";
            clientFirstName.classList.add("is-invalid");
            clientFirstName.classList.remove("is-valid");
        } else {
            clientFirstNameHelp.textContent = "✅ Prénom valide";
            clientFirstName.classList.remove("is-invalid");
            clientFirstName.classList.add("is-valid");
        }
    });

    clientLastName.addEventListener("input", () => {
        const value = clientLastName.value.trim();
        if (!/^[a-zA-ZÀ-ÿ]+$/.test(value)) {
            clientLastNameHelp.textContent = "⚠️ Le nom doit contenir uniquement des lettres";
            clientLastName.classList.add("is-invalid");
            clientLastName.classList.remove("is-valid");
        } else {
            clientLastNameHelp.textContent = "✅ Nom valide";
            clientLastName.classList.remove("is-invalid");
            clientLastName.classList.add("is-valid");
        }
    });

    clientPhone.addEventListener("input", () => {
        const regex = /^(?:(?:\+|00)33|0)\s*[1-9](?:[\s.-]*\d{2}){4}$/;
        if (!regex.test(clientPhone.value)) {
            clientPhoneHelp.textContent = "⚠️ Format invalide (ex: 06 12 34 56 78)";
            clientPhone.classList.add("is-invalid");
            clientPhone.classList.remove("is-valid");
        } else {
            clientPhoneHelp.textContent = "✅ Numéro valide";
            clientPhone.classList.remove("is-invalid");
            clientPhone.classList.add("is-valid");
        }
    });

    clientEmail.addEventListener("input", () => {
        const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        if (!regex.test(clientEmail.value)) {
            clientEmailHelp.textContent = "⚠️ Format d'email invalide";
            clientEmail.classList.add("is-invalid");
            clientEmail.classList.remove("is-valid");
        } else {
            clientEmailHelp.textContent = "✅ Email valide";
            clientEmail.classList.remove("is-invalid");
            clientEmail.classList.add("is-valid");
        }
    });

    customerId.addEventListener("input", () => {
        const regex = /^[A-Z0-9]{3,10}$/;
        if (!regex.test(customerId.value)) {
            customerIdHelp.textContent = "⚠️ Format invalide (3-10 caractères, lettres majuscules et chiffres)";
            customerId.classList.add("is-invalid");
            customerId.classList.remove("is-valid");
        } else {
            customerIdHelp.textContent = "✅ ID valide";
            clientEmail.classList.remove("is-invalid");
            clientEmail.classList.add("is-valid");
        }
    });

    clientUsername.addEventListener("input", () => {
        const regex = /^[a-zA-Z0-9_]{3,20}$/;
        if (!regex.test(clientUsername.value)) {
            clientUsernameHelp.textContent = "⚠️ 3 à 20 caractères (lettres, chiffres, _)";
            clientUsername.classList.add("is-invalid");
            clientUsername.classList.remove("is-valid");
        } else {
            clientUsernameHelp.textContent = "✅ Nom d'utilisateur valide";
            clientUsername.classList.remove("is-invalid");
            clientUsername.classList.add("is-valid");
        }
    });

    clientPassword.addEventListener("input", () => {
        const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
        if (!regex.test(clientPassword.value)) {
            clientPasswordHelp.textContent = "⚠️ 8+ caractères avec au moins 1 majuscule, 1 minuscule et 1 chiffre";
            clientPassword.classList.add("is-invalid");
            clientPassword.classList.remove("is-valid");
        } else {
            clientPasswordHelp.textContent = "✅ Mot de passe valide";
            clientPassword.classList.remove("is-invalid");
            clientPassword.classList.add("is-valid");
        }
    });

    clientRole.addEventListener("input", () => {
        const validRoles = ['client', 'vip', 'business'];
        if (!validRoles.includes(clientRole.value)) {
            clientRole.classList.add("is-invalid");
            clientRole.classList.remove("is-valid");
        } else {
            clientRole.classList.remove("is-invalid");
            clientRole.classList.add("is-valid");
        }
    });

    function validateCurrentStep() {
        let isValid = true;

        if (currentStep === 1) {
            if (!clientFirstName.checkValidity()) {
                clientFirstName.reportValidity();
                isValid = false;
            }
            if (!clientLastName.checkValidity()) {
                clientLastName.reportValidity();
                isValid = false;
            }
            if (!clientPhone.checkValidity()) {
                clientPhone.reportValidity();
                isValid = false;
            }
            if (!clientEmail.checkValidity()) {
                clientEmail.reportValidity();
                isValid = false;
            }
        } else if (currentStep === 2) {
            if (!customerId.checkValidity()) {
                customerId.reportValidity();
                isValid = false;
            }
            if (!clientUsername.checkValidity()) {
                clientUsername.reportValidity();
                isValid = false;
            }
            if (!clientPassword.checkValidity()) {
                clientPassword.reportValidity();
                isValid = false;
            }
            if (!clientRole.checkValidity() || !['client', 'vip', 'business'].includes(clientRole.value)) {
                clientRole.reportValidity();
                isValid = false;
            }
        }

        return isValid;
    }

    async function addClient(event) {
        event.preventDefault();

        if (!validateCurrentStep()) return;

        showLoader();

        try {
            const formData = {
                firstname: clientFirstName.value.trim(),
                lastname: clientLastName.value.trim(),
                phone: clientPhone.value.trim(),
                email: clientEmail.value.trim(),
                customerId: customerId.value.trim(),
                username: clientUsername.value.trim(),
                password: clientPassword.value.trim(),
                role: clientRole.value
            };

            const response = await fetch(API_ENDPOINTS.BASE, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            closeModal();
            showNotification('Client ajouté avec succès', 'success');
            fetchClients();
        } catch (error) {
            console.error('Erreur lors de l’ajout du client:', error);
            showNotification(`Erreur lors de l’ajout du client: ${error.message}`, 'error');
        } finally {
            hideLoader();
        }
    }

    async function updateClient(event) {
        event.preventDefault();
        const clientId = saveClientBtn.getAttribute('data-edit-id');
        if (!clientId) return;

        if (!validateCurrentStep()) return;

        showLoader();

        try {
            const formData = {
                firstname: clientFirstName.value.trim(),
                lastname: clientLastName.value.trim(),
                phone: clientPhone.value.trim(),
                email: clientEmail.value.trim(),
                customerId: customerId.value.trim(),
                username: clientUsername.value.trim(),
                password: clientPassword.value.trim(),
                role: clientRole.value
            };

            const response = await fetch(API_ENDPOINTS.UPDATE(clientId), {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            closeModal();
            showNotification('Client mis à jour avec succès', 'success');
            fetchClients();
        } catch (error) {
            console.error('Erreur lors de la mise à jour du client:', error);
            showNotification('Erreur lors de la mise à jour du client', 'error');
        } finally {
            hideLoader();
        }
    }

    function setupCheckboxListeners() {
        const checkboxes = document.querySelectorAll('tbody .form-check-input');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateSelectAll();
                updateBulkActions();
            });
        });
    }

    selectAllCheckbox.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('tbody .form-check-input');
        checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        updateBulkActions();
    });

    function updateSelectAll() {
        const checkboxes = document.querySelectorAsll('tbody .form-check-input');
        const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
        const someChecked = Array.from(checkboxes).some(checkbox => checkbox.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }

    function updateBulkActions() {
        const checkboxes = document.querySelectorAll('tbody .form-check-input');
        const selectedCount = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
        const bulkActions = document.querySelector('.bulk-actions');

        if (selectedCount > 0) {
            if (!bulkActions) {
                createBulkActionsBar(selectedCount);
            } else {
                updateBulkActionsCount(selectedCount);
            }
        } else if (bulkActions) {
            bulkActions.classList.remove('show');
            bulkActions.addEventListener('transitionend', () => bulkActions.remove(), { once: true });
        }
    }

    function createBulkActionsBar(count) {
        const bulkActions = document.createElement('div');
        bulkActions.className = 'bulk-actions';
        bulkActions.innerHTML = `
            <span class="bulk-actions-count">${count} sélectionné(s)</span>
            <button class="btn btn-outline-danger" data-action="bulk-delete">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Supprimer
            </button>
            <button class="btn btn-outline-secondary" data-action="bulk-export">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                Exporter
            </button>
        `;
        document.body.appendChild(bulkActions);
        setTimeout(() => bulkActions.classList.add('show'), 100);
        bulkActions.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', handleBulkAction);
        });
    }

    function updateBulkActionsCount(count) {
        const countElement = document.querySelector('.bulk-actions-count');
        if (countElement) {
            countElement.textContent = `${count} sélectionné(s)`;
        }
    }

    async function handleBulkAction(e) {
        const action = e.currentTarget.dataset.action;
        const checkboxes = document.querySelectorAll('tbody .form-check-input');
        const selectedRows = Array.from(checkboxes)
            .filter(checkbox => checkbox.checked)
            .map(checkbox => checkbox.closest('tr'));

        switch(action) {
            case 'bulk-delete':
                confirmBulkDelete(selectedRows);
                break;
            case 'bulk-export':
                exportSelectedClients(selectedRows);
                break;
        }
    }

    async function confirmBulkDelete(rows) {
        if (rows.length === 0) return;

        const userConfirmed = await showConfirmDialog({
            title: 'Suppression en masse',
            message: `Êtes-vous sûr de vouloir supprimer ${rows.length} client(s) ?`,
            confirmText: 'Supprimer',
            cancelText: 'Annuler',
            type: 'danger'
        });

        if (!userConfirmed) return;

        rows.forEach(row => deleteClient(row));
    }

    function exportSelectedClients(rows) {
        showLoader();

        const clients = rows.map(row => ({
            id: row.querySelector('.client-id').textContent.replace('#CLD', ''),
            lastname: row.querySelector('.client-details h6').textContent.split(' ')[0],
            firstname: row.querySelector('.client-details h6').textContent.split(' ')[1] || '',
            username: row.cells[2].textContent,
            phone: row.cells[3].textContent,
            status: row.querySelector('.status-badge').textContent
        }));

        if (!clients.length) {
            showNotification('Aucun client sélectionné pour l’exportation.', 'warning');
            hideLoader();
            return;
        }

        let csvContent = 'ID,Nom,Prénom,Nom d\'utilisateur,Téléphone,Statut\n';
        clients.forEach(client => {
            csvContent += `${client.id},"${client.lastname}","${client.firstname}","${client.username}","${client.phone}","${client.status}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'selected_clients.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showNotification('Clients sélectionnés exportés avec succès !', 'success');
        hideLoader();
    }

    async function handleStatusToggle(event) {
        if (event.target.classList.contains('status-toggle')) {
            const row = event.target.closest('tr');
            const clientId = row.querySelector('.client-id').textContent.replace('#CLD', '');
            const status = event.target.checked ? 'Enabled' : 'Disabled';
            const param = status === 'Enabled' ? 'enable' : 'disable';

            const userConfirmed = await showConfirmDialog({
                title: 'Confirmation',
                message: `Voulez-vous vraiment ${status === 'Enabled' ? 'activer' : 'désactiver'} ce client ?`,
                confirmText: 'Oui',
                cancelText: 'Non',
                type: status === 'Enabled' ? 'success' : 'warning'
            });

            if (!userConfirmed) {
                event.target.checked = !event.target.checked;
                return;
            }

            showLoader();

            try {
                const response = await fetch(API_ENDPOINTS.STATUS(clientId, param), {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });

                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }

                showNotification(`Statut du client ${clientId} mis à jour`, 'info');
                fetchClients();
            } catch (error) {
                console.error('Erreur de mise à jour du statut:', error);
                showNotification('Erreur lors de la mise à jour du statut', 'error');
            } finally {
                hideLoader();
            }
        }
    }

    function showLoader() {
        const loader = document.getElementById('loader');
        if (loader) loader.classList.add('show');
    }

    function hideLoader() {
        const loader = document.getElementById('loader');
        if (loader) loader.classList.remove('show');
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            ${getNotificationIcon(type)}
            <div class="notification-content">
                <div class="notification-message">${message}</div>
                <div class="notification-progress"></div>
            </div>
        `;

        document.body.appendChild(notification);
        requestAnimationFrame(() => notification.classList.add('show'));

        const progress = notification.querySelector('.notification-progress');
        progress.style.animation = 'notification-progress 3s linear forwards';

        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    function getNotificationIcon(type) {
        switch(type) {
            case 'success':
                return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="var(--green-500)"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            case 'error':
                return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="var(--red-500)"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
            default:
                return '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="var(--blue-500)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>';
        }
    }

    async function showConfirmDialog({ title, message, confirmText = 'Confirmer', cancelText = 'Annuler', type = 'info' }) {
        return new Promise(resolve => {
            const dialog = document.createElement('div');
            dialog.className = `confirm-dialog modal confirm-dialog-${type}`;
            dialog.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5>${title}</h5>
                            <button type="button" class="modal-close" data-action="cancel">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                        </div>
                        <div class="modal-footer">
                            ${cancelText ? `<button type="button" class="btn btn-secondary" data-action="cancel">${cancelText}</button>` : ''}
                            <button type="button" class="btn btn-${type}" data-action="confirm">${confirmText}</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);
            setTimeout(() => dialog.classList.add('show'), 50);

            dialog.addEventListener('click', e => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                if (action === 'confirm') {
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        dialog.remove();
                        resolve(true);
                    }, 300);
                }
                if (action === 'cancel' || e.target === dialog) {
                    dialog.classList.remove('show');
                    setTimeout(() => {
                        dialog.remove();
                        resolve(false);
                    }, 300);
                }
            });
        });
    }

    function highlightSearchResults(searchTerm) {
        const rows = document.querySelectorAll('tbody tr');
        if (!searchTerm) {
            rows.forEach(row => {
                row.querySelectorAll('td').forEach(td => {
                    td.innerHTML = td.innerHTML.replace(/<mark>(.*?)<\/mark>/g, '$1');
                });
            });
            return;
        }

        const regex = new RegExp(searchTerm, 'gi');
        rows.forEach(row => {
            row.querySelectorAll('td').forEach(td => {
                if (!td.querySelector('.actions')) {
                    const originalText = td.getAttribute('data-original-text') || td.innerText;
                    td.setAttribute('data-original-text', originalText);
                    td.innerHTML = originalText.replace(regex, match => `<mark>${match}</mark>`);
                }
            });
        });
    }

    searchInput.addEventListener('input', debounce(function() {
        const searchTerm = this.value.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const rows = document.querySelectorAll('tbody tr');
        let resultsFound = false;

        rows.forEach(row => {
            const text = row.textContent.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const match = text.includes(searchTerm);
            row.style.display = match ? '' : 'none';
            if (match) resultsFound = true;
        });

        highlightSearchResults(searchTerm);

        const noResultsMessage = document.querySelector('.no-results');
        if (!resultsFound) {
            if (!noResultsMessage) {
                const message = document.createElement('tr');
                message.classList.add('no-results');
                message.innerHTML = `<td colspan="6" class="text-center text-muted">Aucun résultat trouvé</td>`;
                document.querySelector('tbody').appendChild(message);
            }
        } else {
            if (noResultsMessage) noResultsMessage.remove();
        }
    }, 300));

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    async function fetchClients(page = 1, status = "") {
        showLoader();

        let apiUrlWithParams = `${API_ENDPOINTS.BASE}?page=${page}&limit=${clientsPerPage}`;
        const statusMapping = { "active": "Enabled", "inactive": "Disabled" };
        if (status && statusMapping[status]) {
            apiUrlWithParams += `&status=${statusMapping[status]}`;
        }

        try {
            const response = await fetch(apiUrlWithParams, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            const json = await response.json();
            totalClients = json.total;
            renderClients(json.data);
            updatePagination();
        } catch (error) {
            console.error('Erreur de récupération des clients:', error);
            showNotification('Impossible de charger les clients.', 'error');
        } finally {
            hideLoader();
        }
    }

    function renderClients(clients) {
        tbody.innerHTML = '';

        clients.forEach(client => {
            const status = client.status === 'Enabled' ? 'success' : 'warning';
            const isChecked = client.status === 'Enabled' ? 'checked' : '';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" class="form-check-input"></td>
                <td>
                    <div class="client-info">
                        <div class="client-avatar">${client.lastname?.charAt(0).toUpperCase() ?? ''}${client.firstname?.charAt(0).toUpperCase() ?? ''}</div>
                        <div class="client-details">
                            <h6>${client.lastname || 'Inconnu'} ${client.firstname || ''}</h6>
                            <span class="client-id">${formatClientId(client.id)}</span>
                        </div>
                    </div>
                </td>
                <td>${client.username || 'Non renseigné'}</td>
                <td>${client.phone || 'Non renseigné'}</td>
                <td>
                    <div class="status-container d-flex align-items-center gap-2">
                        <span class="status-badge badge ${status}">${client.status || 'Inconnu'}</span>
                        <label class="status-switch">
                            <input type="checkbox" class="status-toggle" ${isChecked}>
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                </td>
                <td>
                    <div class="actions">
                        <button class="btn btn-sm btn-icon" data-action="view" title="Voir">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                        </button>
                        <button class="btn btn-sm btn-icon" data-action="edit" title="Modifier">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                            </svg>
                        </button>
                        <button class="btn btn-sm btn-icon text-danger" data-action="delete" title="Supprimer">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        document.getElementById("paginationInfo").textContent = `Affichage de ${(currentPage - 1) * clientsPerPage + 1}-${Math.min(currentPage * clientsPerPage, totalClients)} sur ${totalClients} clients`;
        setupCheckboxListeners();
        tbody.addEventListener('change', handleStatusToggle);
        tbody.addEventListener('click', handleClientActions);
    }

    function formatClientId(id) {
        return id ? `#CLD${String(id).padStart(4, '0')}` : '';
    }

    function updatePagination() {
        const totalPages = Math.ceil(totalClients / clientsPerPage);
        const paginationElement = document.getElementById("pagination");
        paginationElement.innerHTML = '';

        const prevButton = document.createElement("li");
        prevButton.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevButton.innerHTML = `<a class="page-link" href="#" aria-label="Page précédente">Précédent</a>`;
        prevButton.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                fetchClients(currentPage);
            }
        });
        paginationElement.appendChild(prevButton);

        for (let i = 1; i <= totalPages; i++) {
            const pageItem = document.createElement("li");
            pageItem.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageItem.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            pageItem.addEventListener("click", (e) => {
                e.preventDefault();
                currentPage = i;
                fetchClients(currentPage);
            });
            paginationElement.appendChild(pageItem);
        }

        const nextButton = document.createElement("li");
        nextButton.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextButton.innerHTML = `<a class="page-link" href="#" aria-label="Page suivante">Suivant</a>`;
        nextButton.addEventListener("click", (e) => {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                fetchClients(currentPage);
            }
        });
        paginationElement.appendChild(nextButton);
    }

    async function exportClientsToCSV() {
        showLoader();

        try {
            const response = await fetch(`${API_ENDPOINTS.BASE}?limit=10000`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            const json = await response.json();
            const clients = json.data;
            if (!clients || clients.length === 0) {
                showNotification("Aucun client à exporter.", "warning");
                return;
            }

            let csvContent = "ID,Nom,Prénom,Nom d'utilisateur,Téléphone,Statut\n";
            clients.forEach(client => {
                csvContent += `${client.id},"${client.lastname || ''}","${client.firstname || ''}","${client.username || ''}","${client.phone || ''}","${client.status || ''}"\n`;
            });

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "clients.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification("Exportation réussie !", "success");
        } catch (error) {
            console.error("Erreur d'exportation CSV :", error);
            showNotification("Échec de l'exportation.", "error");
        } finally {
            hideLoader();
        }
    }

    document.getElementById("exportCsv").addEventListener("click", exportClientsToCSV);

    function handleClientActions(event) {
        const target = event.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        const row = target.closest('tr');

        switch (action) {
            case 'view':
                viewClient(row);
                break;
            case 'edit':
                editClient(row);
                break;
            case 'delete':
                deleteClient(row);
                break;
        }
    }

    function viewClient(row) {
        const clientId = row.querySelector('.client-id').textContent.replace('#CLD', '');
        const clientName = row.querySelector('.client-details h6').textContent;
        const clientUsername = row.cells[2].textContent;
        const clientPhone = row.cells[3].textContent;
        const clientStatus = row.querySelector('.status-badge').textContent;

        showConfirmDialog({
            title: 'Détails du client',
            message: `
                <div class="client-details-view">
                    <p><strong>ID:</strong> ${clientId}</p>
                    <p><strong>Nom:</strong> ${clientName}</p>
                    <p><strong>Nom d'utilisateur:</strong> ${clientUsername}</p>
                    <p><strong>Téléphone:</strong> ${clientPhone}</p>
                    <p><strong>Statut:</strong> ${clientStatus}</p>
                </div>
            `,
            confirmText: 'Fermer',
            cancelText: null,
            type: 'info'
        });
    }

    function editClient(row) {
        const clientId = row.querySelector('.client-id').textContent.replace('#CLD', '');
        const clientName = row.querySelector('.client-details h6').textContent;
        const clientUsername = row.cells[2].textContent;
        const clientPhone = row.cells[3].textContent;

        const [lastname, firstname] = clientName.split(' ');
        clientFirstName.value = firstname || '';
        clientLastName.value = lastname || '';
        clientUsername.value = clientUsername;
        clientPhone.value = clientPhone;
        clientEmail.value = ''; // Note: Email n'est pas affiché dans la table, à récupérer via API si nécessaire
        customerId.value = clientId;
        clientPassword.value = '';
        clientRole.value = '';

        modal.style.display = 'block';
        modal.classList.add('show');
        document.body.classList.add('modal-open');

        if (!document.querySelector('.modal-backdrop')) {
            const backdrop = document.createElement('div');
            backdrop.classList.add('modal-backdrop', 'fade', 'show');
            document.body.appendChild(backdrop);
        }

        saveClientBtn.setAttribute('data-edit-id', clientId);
        goToStep(1);
    }

    async function deleteClient(row) {
        const clientId = row.querySelector('.client-id').textContent.replace('#CLD', '');

        const userConfirmed = await showConfirmDialog({
            title: 'Supprimer le client',
            message: `Êtes-vous sûr de vouloir supprimer le client ${clientId} ?`,
            confirmText: 'Supprimer',
            cancelText: 'Annuler',
            type: 'danger'
        });

        if (!userConfirmed) return;

        showLoader();

        try {
            const response = await fetch(API_ENDPOINTS.DELETE(clientId), {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }

            showNotification(`Client ${clientId} supprimé avec succès !`, 'success');
            fetchClients();
        } catch (error) {
            console.error('Erreur lors de la suppression du client:', error);
            showNotification('Échec de la suppression du client.', 'error');
        } finally {
            hideLoader();
        }
    }

    document.querySelector('[data-filter="status"]').addEventListener("change", function () {
        const selectedStatus = this.value;
        currentPage = 1;
        fetchClients(currentPage, selectedStatus);
    });

    document.querySelector('[data-action="reset-filters"]').addEventListener('click', () => {
        currentPage = 1;
        document.querySelector('[data-filter="status"]').value = '';
        document.querySelector('#search-input').value = '';
        document.querySelector('#selectAll').checked = false;

        const bulkActions = document.querySelector('.bulk-actions');
        if (bulkActions) {
            bulkActions.classList.remove('show');
        }

        fetchClients();
    });

    initFormSteps();
    fetchClients();
});